#!/usr/bin/env bash
# Move a project directory and rename its Claude Code config accordingly

set -euo pipefail

usage() {
  echo "Usage: cmv <old-path> <new-path>"
  echo "Moves a project directory and renames its ~/.claude/projects/ config"
  echo "and updates ~/.claude.json project entries"
  echo ""
  echo "If old-path doesn't exist but new-path does, assumes mv was already done"
  echo "and just updates Claude configs."
  exit 1
}

[[ $# -eq 2 ]] || usage

raw_old="$1"
raw_new="$2"

# Resolve a path to absolute (works for existing paths)
resolve_path() {
  (cd "$1" && pwd)
}

# Resolve a non-existent path by resolving parent + basename
resolve_new_path() {
  local p="$1"
  local parent dir
  parent="$(cd "$(dirname "$p")" 2>/dev/null && pwd)" || return 1
  echo "$parent/$(basename "$p")"
}

# Encode path to Claude's project dir format: /foo/bar/.baz → -foo-bar-baz
encode_path() {
  echo "$1" | sed 's|/|-|g; s|\.||g'
}

# Determine state: did mv happen already?
old_exists=false
new_exists=false
[[ -d "$raw_old" ]] && old_exists=true
[[ -d "$raw_new" ]] && new_exists=true

if $old_exists && $new_exists; then
  echo "Error: Both $raw_old and $raw_new exist (ambiguous)" >&2
  exit 1
elif ! $old_exists && ! $new_exists; then
  echo "Error: Neither $raw_old nor $raw_new exists" >&2
  exit 1
elif $old_exists; then
  # Normal case: old exists, new doesn't
  old_path="$(resolve_path "$raw_old")"
  new_path="$(resolve_new_path "$raw_new")" || {
    echo "Error: parent directory of $raw_new does not exist" >&2
    exit 1
  }
  already_moved=false
else
  # Already moved: old doesn't exist, new does
  new_path="$(resolve_path "$raw_new")"
  # Infer old_path from raw_old (resolve relative to cwd or use as-is if absolute)
  if [[ "$raw_old" = /* ]]; then
    old_path="$raw_old"
  else
    old_path="$(pwd)/$raw_old"
  fi
  # Normalize (remove trailing slashes, ./ etc)
  old_path="$(echo "$old_path" | sed 's|/\+|/|g; s|/$||')"
  already_moved=true
  echo "Note: $raw_old doesn't exist but $raw_new does; assuming mv already done"
fi

old_encoded="$(encode_path "$old_path")"
new_encoded="$(encode_path "$new_path")"

claude_projects="$HOME/.claude/projects"
claude_json="$HOME/.claude.json"
old_config="$claude_projects/$old_encoded"
new_config="$claude_projects/$new_encoded"

# Check if Claude is running in the old or new project
for check_path in "$old_path" "$new_path"; do
  if pgrep -f "claude.*$check_path" >/dev/null 2>&1; then
    echo "Error: Claude appears to be running in $check_path" >&2
    echo "Exit that session first, then retry." >&2
    exit 1
  fi
done

# Move the project directory (if not already done)
if ! $already_moved; then
  echo "Moving project: $old_path → $new_path"
  mv "$old_path" "$new_path"
fi

# Move Claude projects/ config if it exists
if [[ -d "$old_config" ]]; then
  if [[ -e "$new_config" ]]; then
    echo "Warning: $new_config already exists, not moving Claude config" >&2
  else
    echo "Moving Claude config: $old_encoded → $new_encoded"
    mv "$old_config" "$new_config"
  fi
else
  echo "No Claude config found at $old_config"
fi

# Update ~/.claude.json if it has an entry for the old path
if [[ -f "$claude_json" ]]; then
  if jq -e ".projects[\"$old_path\"]" "$claude_json" >/dev/null 2>&1; then
    echo "Updating ~/.claude.json: $old_path → $new_path"
    jq ".projects[\"$new_path\"] = .projects[\"$old_path\"] | del(.projects[\"$old_path\"])" \
      "$claude_json" > "$claude_json.tmp" && mv "$claude_json.tmp" "$claude_json"
  else
    echo "No ~/.claude.json entry for $old_path"
  fi
fi

echo "Done"
